# ヒートマップ閲覧パフォーマンス問題 - 課題リスト

**作成日**: 2025年1月26日  
**優先度**: 🔴 高（緊急）

---

## 🚨 緊急課題

### 課題1: APIタイムアウトの発生

**問題**:
- `/api/heatmap`エンドポイントが60秒以内に応答を返せず、タイムアウトエラーが発生
- 特に「全期間」を選択した場合に発生しやすい

**影響**:
- ユーザーがヒートマップを閲覧できない
- エラーメッセージが表示されるだけで、データが見られない

**原因の仮説**:
1. ClickHouseクエリが重すぎる（数百万行をスキャン）
2. GROUP BY処理が時間がかかる
3. キャッシュが効いていない

**解決策の方向性**:
- [ ] クエリの最適化（インデックス、サンプリング）
- [ ] 集約テーブルの活用
- [ ] キャッシュ戦略の改善
- [ ] 非同期処理の実装

---

### 課題2: ヒートマップページの読み込みが重い

**問題**:
- ページを開いてからヒートマップが表示されるまで時間がかかる
- ブラウザがフリーズするような状態になることがある

**影響**:
- ユーザー体験の悪化
- ページの離脱率が高くなる可能性

**原因の仮説**:
1. 最大10,000ポイントを一度に描画しようとしている
2. フロントエンドでのデータ処理が重い
3. API応答時間が長い

**解決策の方向性**:
- [ ] データポイントの制限（10,000 → 1,000）
- [ ] 段階的読み込みの実装
- [ ] Web Workerの活用
- [ ] 仮想化の実装

---

## ⚠️ 重要課題

### 課題3: キャッシュが効いていない

**問題**:
- キャッシュキーに`heatmap_type`が含まれていない
- Redis接続が失敗している可能性
- キャッシュヒット率が低い

**影響**:
- 毎回ClickHouseクエリを実行する必要がある
- API応答時間が長い

**解決策の方向性**:
- [ ] キャッシュキーに`heatmap_type`を追加
- [ ] Redis接続の確認と修正
- [ ] キャッシュTTLの調整
- [ ] キャッシュウォーミングの実装

---

### 課題4: ClickHouseクエリが重い

**問題**:
- 全期間選択時、数百万行をスキャン
- GROUP BY処理が時間がかかる
- スクロール深度ヒートマップで2つのクエリを実行

**影響**:
- API応答時間が長い
- タイムアウトの発生

**解決策の方向性**:
- [ ] インデックスの最適化
- [ ] サンプリングの実装
- [ ] 集約テーブルの活用
- [ ] クエリの最適化（2つのクエリを1つに統合）

---

## 📋 改善課題

### 課題5: フロントエンドの最適化不足

**問題**:
- 最大10,000ポイントを一度に描画
- データ取得から描画まで時間がかかる
- メインスレッドがブロックされる

**影響**:
- ユーザー体験の悪化
- ブラウザのフリーズ

**解決策の方向性**:
- [ ] データポイントの制限
- [ ] 段階的読み込みの実装
- [ ] Web Workerの活用
- [ ] 仮想化の実装

---

### 課題6: エラーハンドリングの不足

**問題**:
- タイムアウト時の適切なエラーメッセージがない
- ユーザーに問題の原因が伝わらない

**影響**:
- ユーザーの混乱
- サポートへの問い合わせが増える可能性

**解決策の方向性**:
- [ ] タイムアウト時の適切なエラーメッセージ
- [ ] リトライ機能の実装
- [ ] ローディング状態の改善

---

## 🎯 優先順位

### 即座に実施（Phase 1）

1. **キャッシュキーの修正** ⏱️ 30分
   - `heatmap_type`をキャッシュキーに追加
   - 影響範囲: `lib/redis.ts`

2. **LIMITの削減** ⏱️ 15分
   - 10,000件 → 1,000件に削減
   - 影響範囲: `lib/clickhouse.ts`

3. **エラーハンドリングの改善** ⏱️ 30分
   - タイムアウト時の適切なエラーメッセージ
   - 影響範囲: `app/api/heatmap/route.ts`, `app/heatmap/page.tsx`

### 1週間以内（Phase 2）

4. **集約テーブルの活用** ⏱️ 2-3日
   - `heatmap_summary`テーブルに事前集計
   - バックグラウンドジョブで更新

5. **インデックスの最適化** ⏱️ 1日
   - 複合インデックスの追加
   - クエリパフォーマンスの測定

6. **フロントエンドの最適化** ⏱️ 2-3日
   - データポイントの制限
   - 段階的読み込みの実装

### 1ヶ月以内（Phase 3）

7. **非同期処理の実装** ⏱️ 1週間
   - 長時間クエリの非同期化
   - ジョブ管理システム

8. **ストリーミング対応** ⏱️ 1週間
   - SSEの実装
   - 段階的なデータ送信

---

## 📊 成功指標

### 目標値

| 指標 | 現状 | 目標 |
|------|------|------|
| API応答時間（キャッシュあり） | - | < 100ms |
| API応答時間（キャッシュなし、期間指定） | タイムアウト | < 5秒 |
| API応答時間（キャッシュなし、全期間） | タイムアウト | < 10秒 |
| フロントエンド描画時間 | 10秒以上 | < 3秒 |
| キャッシュヒット率 | 不明 | > 80% |
| タイムアウト発生率 | 高 | 0% |

---

## 🔗 関連ドキュメント

- [ヒートマップ閲覧パフォーマンス問題 - AI相談用仕様書](./heatmap-performance-issue-consultation.md)
- [パフォーマンス改善提案](./performance-optimization-proposal.md)
- [パフォーマンス改善実装](./performance-optimization-implementation.md)

---

**最終更新**: 2025年1月26日


