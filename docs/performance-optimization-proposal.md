# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ææ¡ˆ

**ä½œæˆæ—¥**: 2025å¹´1æœˆ26æ—¥  
**ç›®çš„**: ãƒ‡ãƒ¼ã‚¿é‡å¢—åŠ ã«ä¼´ã†ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã®æ”¹å–„ç­–ã‚’ææ¡ˆ

---

## ğŸ” ç¾çŠ¶ã®åˆ†æ

### ç¾åœ¨ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹èª²é¡Œ

1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®è² è·**
   - å¤§é‡ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ¯å›é›†è¨ˆã—ã¦ã„ã‚‹
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±è¨ˆã®è¨ˆç®—ãŒé‡ã„ï¼ˆå…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒ«ãƒ¼ãƒ—å‡¦ç†ï¼‰
   - æœŸé–“æ¯”è¼ƒã§2å›ã®ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹

2. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®ä¸è¶³**
   - æœŸé–“åˆ¥ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ãŒä¸å®Œå…¨
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç„¡åŠ¹åŒ–æˆ¦ç•¥ãŒãªã„
   - éƒ¨åˆ†çš„ãªãƒ‡ãƒ¼ã‚¿æ›´æ–°ãŒã§ããªã„

3. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®è² è·**
   - å¤§é‡ã®ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒã‚¤ãƒ³ãƒˆã‚’ä¸€åº¦ã«æç”»
   - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ãŒé »ç¹ã™ãã‚‹å¯èƒ½æ€§

---

## ğŸ’¡ æ”¹å–„ææ¡ˆ

### ææ¡ˆ1: é›†ç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆï¼ˆæ¨å¥¨ï¼‰

#### æ¦‚è¦

æ—¥æ¬¡ãƒ»æ™‚é–“åˆ¥ã®é›†ç´„ãƒ‡ãƒ¼ã‚¿ã‚’äº‹å‰è¨ˆç®—ã—ã¦ä¿å­˜ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã€‚

#### å®Ÿè£…æ–¹æ³•

```sql
-- æ—¥æ¬¡é›†ç´„ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE IF NOT EXISTS clickinsight.daily_aggregates (
  site_id String,
  page_url String,
  date Date,
  event_type String, -- 'click', 'scroll', 'read'
  y_coordinate UInt16,
  click_count UInt32,
  session_count UInt32,
  total_duration_ms UInt64,
  created_at DateTime DEFAULT now()
) ENGINE = SummingMergeTree(click_count, session_count, total_duration_ms)
ORDER BY (site_id, page_url, date, event_type, y_coordinate)
PARTITION BY toYYYYMM(date);

-- æ™‚é–“åˆ¥é›†ç´„ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç”¨ï¼‰
CREATE TABLE IF NOT EXISTS clickinsight.hourly_aggregates (
  site_id String,
  page_url String,
  date_hour DateTime,
  event_type String,
  y_coordinate UInt16,
  click_count UInt32,
  session_count UInt32,
  total_duration_ms UInt64,
  created_at DateTime DEFAULT now()
) ENGINE = SummingMergeTree(click_count, session_count, total_duration_ms)
ORDER BY (site_id, page_url, date_hour, event_type, y_coordinate)
PARTITION BY toYYYYMM(date_hour);
```

#### ãƒ¡ãƒªãƒƒãƒˆ

- âœ… **ã‚¯ã‚¨ãƒªé€Ÿåº¦ã®å¤§å¹…å‘ä¸Š**: é›†ç´„æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥å–å¾—
- âœ… **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è² è·ã®è»½æ¸›**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é›†è¨ˆãŒä¸è¦
- âœ… **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: ãƒ‡ãƒ¼ã‚¿é‡ãŒå¢—ãˆã¦ã‚‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒç¶­æŒã•ã‚Œã‚‹

#### ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

- âš ï¸ **å®Ÿè£…ã‚³ã‚¹ãƒˆ**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–ãŒå¿…è¦
- âš ï¸ **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡**: é›†ç´„ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãŒå¿…è¦

---

### ææ¡ˆ2: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–ã«ã‚ˆã‚‹é›†ç´„å‡¦ç†

#### æ¦‚è¦

å®šæœŸçš„ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’é›†ç´„ã—ã¦ã€é›†ç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜ã™ã‚‹ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã€‚

#### å®Ÿè£…æ–¹æ³•

```typescript
// lib/aggregation-job.ts
export async function runDailyAggregation() {
  const yesterday = new Date()
  yesterday.setDate(yesterday.getDate() - 1)
  const dateStr = yesterday.toISOString().split('T')[0]
  
  // 1. ã‚¯ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã®é›†ç´„
  await aggregateClickEvents(dateStr)
  
  // 2. ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ·±åº¦ãƒ‡ãƒ¼ã‚¿ã®é›†ç´„
  await aggregateScrollDepth(dateStr)
  
  // 3. ç†Ÿèª­ã‚¨ãƒªã‚¢ãƒ‡ãƒ¼ã‚¿ã®é›†ç´„
  await aggregateReadArea(dateStr)
  
  // 4. çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®é›†ç´„
  await aggregateStatistics(dateStr)
}

// Cronã‚¸ãƒ§ãƒ–ã§æ¯æ—¥å®Ÿè¡Œï¼ˆä¾‹: Vercel Cron Jobsï¼‰
```

#### å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°

- **æ—¥æ¬¡é›†ç´„**: æ¯æ—¥æ·±å¤œï¼ˆä¾‹: 0:00 UTCï¼‰
- **æ™‚é–“åˆ¥é›†ç´„**: æ¯æ™‚é–“ï¼ˆä¾‹: æ¯æ™‚0åˆ†ï¼‰

---

### ææ¡ˆ3: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®æ”¹å–„

#### ç¾åœ¨ã®å•é¡Œ

```typescript
// æœŸé–“ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã«å«ã¾ã‚Œã¦ã„ãªã„
const key = `heatmap:${siteId}:${pageUrl}${deviceType ? `:${deviceType}` : ''}`
```

#### æ”¹å–„æ¡ˆ

```typescript
// æœŸé–“ã‚’å«ã‚ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼
const key = `heatmap:${siteId}:${pageUrl}:${deviceType || 'all'}:${startDate || 'all'}:${endDate || 'all'}`

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®éšå±¤åŒ–
// 1. çŸ­æœŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ5åˆ†ï¼‰: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ç”¨
// 2. ä¸­æœŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ30åˆ†ï¼‰: çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ç”¨
// 3. é•·æœŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ24æ™‚é–“ï¼‰: é›†ç´„ãƒ‡ãƒ¼ã‚¿ç”¨
```

#### ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç„¡åŠ¹åŒ–æˆ¦ç•¥

```typescript
// æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚ŒãŸã‚‰ã€è©²å½“ã™ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
export async function invalidateCache(siteId: string, pageUrl?: string) {
  const patterns = [
    `heatmap:${siteId}:*`,
    `stats:${siteId}:*`,
    ...(pageUrl ? [`heatmap:${siteId}:${pageUrl}:*`] : [])
  ]
  
  for (const pattern of patterns) {
    await clearCache(pattern)
  }
}
```

---

### ææ¡ˆ4: ãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã¨ãƒªãƒŸãƒƒãƒˆ

#### æ¦‚è¦

å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã€ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã—ã¦è¡¨ç¤ºæ•°ã‚’åˆ¶é™ã€‚

#### å®Ÿè£…æ–¹æ³•

```typescript
// ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
function sampleHeatmapData(data: HeatmapPoint[], maxPoints: number = 1000) {
  if (data.length <= maxPoints) return data
  
  // é‡è¦åº¦ã®é«˜ã„ãƒã‚¤ãƒ³ãƒˆã‚’å„ªå…ˆçš„ã«é¸æŠ
  const sorted = data.sort((a, b) => 
    (b.count || 0) - (a.count || 0)
  )
  
  // ä¸Šä½Nä»¶ + ãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒ«
  const topPoints = sorted.slice(0, maxPoints * 0.7)
  const randomPoints = sorted
    .slice(maxPoints * 0.7)
    .sort(() => Math.random() - 0.5)
    .slice(0, maxPoints * 0.3)
  
  return [...topPoints, ...randomPoints]
}
```

---

### ææ¡ˆ5: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–

#### ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

```sql
ORDER BY (site_id, timestamp)
PARTITION BY toYYYYMM(timestamp)
```

#### æ”¹å–„æ¡ˆ

```sql
-- ã‚ˆã‚ŠåŠ¹ç‡çš„ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
ORDER BY (site_id, url, timestamp, event_type)
PARTITION BY toYYYYMM(timestamp)

-- è¿½åŠ ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
-- ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±è¨ˆç”¨
ORDER BY (site_id, session_id, timestamp)
```

---

### ææ¡ˆ6: ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±è¨ˆã®æœ€é©åŒ–

**ç¾åœ¨ã®å•é¡Œ**:
```typescript
// å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãƒ«ãƒ¼ãƒ—å‡¦ç†
const sessionData = await sessionResult.json()
for (const session of sessionData) {
  // è¨ˆç®—å‡¦ç†
}
```

**æ”¹å–„æ¡ˆ**:
```sql
-- ClickHouseã®é›†ç´„é–¢æ•°ã‚’æ´»ç”¨
SELECT 
  avg(dateDiff('second', session_start, session_end)) as avg_time_on_page,
  countIf(page_views <= 1) as bounce_sessions,
  count() as total_sessions
FROM (
  SELECT 
    session_id,
    min(timestamp) as session_start,
    max(timestamp) as session_end,
    countIf(event_type = 'page_view' OR event_type = 'pageview') as page_views
  FROM clickinsight.events
  WHERE site_id = {site_id:String}
  GROUP BY session_id
)
```

---

### ææ¡ˆ7: ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–

#### æ¦‚è¦

å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç§»å‹•ã—ã¦ã€ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚µã‚¤ã‚ºã‚’å‰Šæ¸›ã€‚

#### å®Ÿè£…æ–¹æ³•

```sql
-- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE IF NOT EXISTS clickinsight.events_archive
AS clickinsight.events
ENGINE = MergeTree()
ORDER BY (site_id, timestamp)
PARTITION BY toYYYYMM(timestamp);

-- 90æ—¥ä»¥ä¸Šå‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ç§»å‹•
INSERT INTO clickinsight.events_archive
SELECT * FROM clickinsight.events
WHERE timestamp < now() - INTERVAL 90 DAY;

DELETE FROM clickinsight.events
WHERE timestamp < now() - INTERVAL 90 DAY;
```

---

### ææ¡ˆ8: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æœ€é©åŒ–

#### ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«

å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã‚’è¡¨ç¤ºã™ã‚‹éš›ã€ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã€‚

#### ãƒ¬ã‚¤ã‚¸ãƒ¼ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°

ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’æ®µéšçš„ã«èª­ã¿è¾¼ã‚€ï¼ˆæœ€åˆã¯ã‚µãƒãƒªãƒ¼ã€è©³ç´°ã¯å¿…è¦ã«å¿œã˜ã¦ï¼‰ã€‚

#### ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã¨ã‚¹ãƒ­ãƒƒãƒˆãƒ«

ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œï¼ˆæœŸé–“å¤‰æ›´ãªã©ï¼‰ã«ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã‚’é©ç”¨ã—ã¦ã€ä¸è¦ãªAPIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‰Šæ¸›ã€‚

---

## ğŸ“Š å„ªå…ˆåº¦ã¨å®Ÿè£…é †åº

### Phase 1: å³åº§ã«å®Ÿè£…å¯èƒ½ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰

1. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã®æ”¹å–„** â­â­â­
   - æœŸé–“ã‚’å«ã‚ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼
   - å®Ÿè£…ã‚³ã‚¹ãƒˆ: ä½
   - åŠ¹æœ: ä¸­

2. **ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–** â­â­â­
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±è¨ˆã®é›†ç´„é–¢æ•°æ´»ç”¨
   - å®Ÿè£…ã‚³ã‚¹ãƒˆ: ä¸­
   - åŠ¹æœ: é«˜

3. **ãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°** â­â­
   - ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒã‚¤ãƒ³ãƒˆã®åˆ¶é™
   - å®Ÿè£…ã‚³ã‚¹ãƒˆ: ä½
   - åŠ¹æœ: ä¸­

### Phase 2: ä¸­æœŸå®Ÿè£…ï¼ˆä¸­å„ªå…ˆåº¦ï¼‰

4. **é›†ç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ** â­â­â­
   - æ—¥æ¬¡ãƒ»æ™‚é–“åˆ¥é›†ç´„ãƒ†ãƒ¼ãƒ–ãƒ«
   - å®Ÿè£…ã‚³ã‚¹ãƒˆ: é«˜
   - åŠ¹æœ: éå¸¸ã«é«˜

5. **ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–** â­â­
   - å®šæœŸçš„ãªé›†ç´„å‡¦ç†
   - å®Ÿè£…ã‚³ã‚¹ãƒˆ: é«˜
   - åŠ¹æœ: é«˜

### Phase 3: é•·æœŸå®Ÿè£…ï¼ˆä½å„ªå…ˆåº¦ï¼‰

6. **ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–** â­
   - å¤ã„ãƒ‡ãƒ¼ã‚¿ã®ç§»å‹•
   - å®Ÿè£…ã‚³ã‚¹ãƒˆ: ä¸­
   - åŠ¹æœ: ä¸­

7. **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–** â­â­
   - è¿½åŠ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½œæˆ
   - å®Ÿè£…ã‚³ã‚¹ãƒˆ: ä½
   - åŠ¹æœ: ä¸­

---

## ğŸ¯ æ¨å¥¨å®Ÿè£…é †åº

### ã‚¹ãƒ†ãƒƒãƒ—1: ã‚¯ã‚¤ãƒƒã‚¯ã‚¦ã‚£ãƒ³ï¼ˆ1-2é€±é–“ï¼‰

1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã®æ”¹å–„
2. ãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
3. ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–

### ã‚¹ãƒ†ãƒƒãƒ—2: ä¸­æœŸçš„æ”¹å–„ï¼ˆ1-2ãƒ¶æœˆï¼‰

4. é›†ç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
5. ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–ã®å®Ÿè£…

### ã‚¹ãƒ†ãƒƒãƒ—3: é•·æœŸçš„æ”¹å–„ï¼ˆ3-6ãƒ¶æœˆï¼‰

6. ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
7. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–
8. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æœ€é©åŒ–

---

## ğŸ“ˆ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### ã‚¯ã‚¨ãƒªé€Ÿåº¦

- **ç¾åœ¨**: 5-10ç§’ï¼ˆå¤§é‡ãƒ‡ãƒ¼ã‚¿ã®å ´åˆï¼‰
- **æ”¹å–„å¾Œ**: 0.5-2ç§’ï¼ˆé›†ç´„ãƒ†ãƒ¼ãƒ–ãƒ«ä½¿ç”¨æ™‚ï¼‰

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è² è·

- **ç¾åœ¨**: é«˜ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é›†è¨ˆï¼‰
- **æ”¹å–„å¾Œ**: ä½ï¼ˆäº‹å‰é›†ç´„ï¼‰

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“

- **ç¾åœ¨**: èª­ã¿è¾¼ã¿æ™‚é–“ãŒé•·ã„
- **æ”¹å–„å¾Œ**: å³åº§ã«è¡¨ç¤º

---

## ğŸ”§ å®Ÿè£…ã®è©³ç´°

### é›†ç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¯ã‚¨ãƒªä¾‹

```sql
-- æ—¥æ¬¡é›†ç´„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’å–å¾—
SELECT 
  y_coordinate,
  click_count,
  session_count,
  click_count / session_count as ctr
FROM clickinsight.daily_aggregates
WHERE site_id = {site_id:String}
  AND page_url = {page_url:String}
  AND event_type = 'click'
  AND date >= {start_date:Date}
  AND date <= {end_date:Date}
GROUP BY y_coordinate
ORDER BY click_count DESC
```

### ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–ã®å®Ÿè£…

```typescript
// app/api/cron/aggregate/route.ts
export async function GET(request: NextRequest) {
  // Cronèªè¨¼
  const authHeader = request.headers.get('authorization')
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }
  
  try {
    await runDailyAggregation()
    return NextResponse.json({ success: true })
  } catch (error) {
    console.error('Aggregation job failed:', error)
    return NextResponse.json({ error: 'Failed' }, { status: 500 })
  }
}
```

---

## ğŸ“ ç›£è¦–ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹

1. **ã‚¯ã‚¨ãƒªå®Ÿè¡Œæ™‚é–“**: å„APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å¿œç­”æ™‚é–“
2. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è² è·**: CPUä½¿ç”¨ç‡ã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡
3. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ‰åŠ¹æ´»ç”¨ç‡
4. **ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º**: ãƒ†ãƒ¼ãƒ–ãƒ«ã‚µã‚¤ã‚ºã®æ¨ç§»

### ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

- ã‚¯ã‚¨ãƒªå®Ÿè¡Œæ™‚é–“ãŒ5ç§’ã‚’è¶…ãˆã‚‹å ´åˆ
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹CPUä½¿ç”¨ç‡ãŒ80%ã‚’è¶…ãˆã‚‹å ´åˆ
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡ãŒ50%ã‚’ä¸‹å›ã‚‹å ´åˆ

---

## ğŸ¯ ã¾ã¨ã‚

### âœ… å®Ÿè£…æ¸ˆã¿ï¼ˆ2025å¹´1æœˆ26æ—¥ï¼‰

1. âœ… **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã®æ”¹å–„**ï¼ˆæœŸé–“ã‚’å«ã‚ã‚‹ï¼‰ - [å®Ÿè£…è©³ç´°](./performance-optimization-implementation.md)
2. âœ… **ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–**ï¼ˆé›†ç´„é–¢æ•°ã®æ´»ç”¨ï¼‰ - [å®Ÿè£…è©³ç´°](./performance-optimization-implementation.md)

### å³åº§ã«å®Ÿè£…å¯èƒ½ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰

3. â³ ãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆè¡¨ç¤ºãƒã‚¤ãƒ³ãƒˆã®åˆ¶é™ï¼‰
   - å®Ÿè£…ã‚³ã‚¹ãƒˆ: ä½
   - åŠ¹æœ: ä¸­

### ä¸­æœŸçš„ã«å®Ÿè£…ã™ã¹ãæ”¹å–„

4. â³ é›†ç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
   - å®Ÿè£…ã‚³ã‚¹ãƒˆ: é«˜
   - åŠ¹æœ: éå¸¸ã«é«˜

5. â³ ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–ã®å®Ÿè£…
   - å®Ÿè£…ã‚³ã‚¹ãƒˆ: é«˜
   - åŠ¹æœ: é«˜

### é•·æœŸçš„ã«æ¤œè¨ã™ã¹ãæ”¹å–„

6. â³ ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
   - å®Ÿè£…ã‚³ã‚¹ãƒˆ: ä¸­
   - åŠ¹æœ: ä¸­

7. â³ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–
   - å®Ÿè£…ã‚³ã‚¹ãƒˆ: ä½
   - åŠ¹æœ: ä¸­

8. â³ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æœ€é©åŒ–
   - å®Ÿè£…ã‚³ã‚¹ãƒˆ: ä¸­
   - åŠ¹æœ: ä¸­

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã®å®Ÿè£…](./performance-optimization-implementation.md) - å®Ÿè£…æ¸ˆã¿ã®æ”¹å–„ã®è©³ç´°

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´1æœˆ26æ—¥

