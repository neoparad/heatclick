# Inngestå®Œå…¨çµ±åˆãƒ»å®Ÿè£…å®Œäº†ã‚µãƒãƒªãƒ¼

**å®Ÿè£…æ—¥**: 2025å¹´1æœˆ26æ—¥  
**ç›®çš„**: ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—é–²è¦§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œã‚’æ ¹æœ¬çš„ã«è§£æ±º

---

## âœ… å®Ÿè£…å®Œäº†é …ç›®

### 1. Inngestãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ âœ…

```
/inngest/
   client.ts                    # Inngestã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
   functions.ts                 # å…¨é–¢æ•°ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
   funcs/
      aggregateDaily.ts         # æ—¥æ¬¡é›†ç´„ã‚¸ãƒ§ãƒ–
      rebuildAll.ts             # éå»ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸé›†ç´„
      warmCache.ts              # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¦ã‚©ãƒ¼ãƒŸãƒ³ã‚°
   lib/
      clickhouse.ts             # ClickHouseæ¥ç¶šï¼ˆå†ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰
      redis.ts                  # Redisæ¥ç¶šï¼ˆå†ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰
      heatmapQuery.ts           # é›†ç´„ãƒ†ãƒ¼ãƒ–ãƒ«å°‚ç”¨ã‚¯ã‚¨ãƒªé–¢æ•°
```

### 2. Inngesté–¢æ•°ã®å®Ÿè£… âœ…

#### aggregateDaily.ts
- **æ©Ÿèƒ½**: æ¯æœ5:00ï¼ˆJSTï¼‰ã«æ˜¨æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†ç´„
- **å®Ÿè¡Œé »åº¦**: Cron `0 4 * * *` (UTC 4:00 = JST 13:00)
- **å‡¦ç†**: `clickinsight.events`ã‹ã‚‰`clickinsight.heatmap_daily_summary`ã«é›†ç´„ãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥

#### rebuildAll.ts
- **æ©Ÿèƒ½**: éå»ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’é›†ç´„ï¼ˆåˆæœŸæ§‹ç¯‰ç”¨ï¼‰
- **ãƒˆãƒªã‚¬ãƒ¼**: ã‚¤ãƒ™ãƒ³ãƒˆ `heatmap.rebuild`
- **å®Ÿè¡Œæ–¹æ³•**: `/api/inngest/rebuild`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œ

#### warmCache.ts
- **æ©Ÿèƒ½**: äººæ°—ãƒšãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’äº‹å‰ç”Ÿæˆ
- **å®Ÿè¡Œé »åº¦**: Cron `0 */6 * * *` (6æ™‚é–“ã”ã¨)
- **å‡¦ç†**: äººæ°—100ãƒšãƒ¼ã‚¸ Ã— 3æœŸé–“ï¼ˆå…¨æœŸé–“ã€7æ—¥ã€30æ—¥ï¼‰ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç”Ÿæˆ

### 3. Next.js APIãƒ«ãƒ¼ãƒˆã®å®Ÿè£… âœ…

#### `/app/api/inngest/route.ts`
- Inngestã®serveé–¢æ•°ã‚’ä½¿ç”¨
- Vercel Functionsã¨ã—ã¦è‡ªå‹•å®Ÿè¡Œ
- ã™ã¹ã¦ã®Inngesté–¢æ•°ã‚’ç™»éŒ²

#### `/app/api/inngest/rebuild/route.ts`
- éå»ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸé›†ç´„ã‚’æ‰‹å‹•å®Ÿè¡Œã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- `heatmap.rebuild`ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡

#### `/app/api/heatmap/route.ts`ï¼ˆæ›´æ–°ï¼‰
- é›†ç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆã‚¯ãƒªãƒƒã‚¯ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼‰
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã«`heatmap_type`ã‚’å«ã‚ã‚‹ã‚ˆã†ã«ä¿®æ­£
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’60ç§’ â†’ 10ç§’ã«çŸ­ç¸®

### 4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æœ€é©åŒ– âœ…

#### `/app/heatmap/page.tsx`ï¼ˆæ›´æ–°ï¼‰
- ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã‚’500ä»¶ã«åˆ¶é™
- ã‚¯ãƒªãƒƒã‚¯æ•°ã§ã‚½ãƒ¼ãƒˆï¼ˆä¸Šä½500ä»¶ï¼‰
- æ®µéšçš„æç”»ï¼ˆ50ä»¶ãšã¤ï¼‰ã‚’å®Ÿè£…
- ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’é˜²æ­¢

### 5. Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ”¹å–„ âœ…

#### `lib/redis.ts`ï¼ˆæ›´æ–°ï¼‰
- `getHeatmapCache`ã¨`setHeatmapCache`ã«`heatmapType`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã«`heatmap_type`ã‚’å«ã‚ã‚‹ã‚ˆã†ã«ä¿®æ­£
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã®å½¢å¼: `heatmap:v2:${siteId}:${pageUrl}:${deviceType}:${heatmapType}:${startDate}:${endDate}`

### 6. ClickHouseãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ âœ…

#### `docs/clickhouse-heatmap-summary-table.sql`
- `heatmap_daily_summary`ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆSummingMergeTreeï¼‰
- `heatmap_daily_summary_mv`ãƒãƒ†ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é›†ç´„ï¼‰
- åˆæœŸãƒ‡ãƒ¼ã‚¿é›†ç´„ã®SQL

---

## ğŸ“¦ è¿½åŠ ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

```json
{
  "dependencies": {
    "inngest": "^3.0.0"
  }
}
```

**ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰**:
```bash
npm install inngest
```

---

## ğŸ”§ å¿…è¦ãªç’°å¢ƒå¤‰æ•°

`.env.local`ã«ä»¥ä¸‹ã‚’è¿½åŠ :

```env
# Inngest
INNGEST_EVENT_KEY=your_inngest_event_key
INNGEST_SIGNING_KEY=your_inngest_signing_key

# ClickHouseï¼ˆæ—¢å­˜ï¼‰
CLICKHOUSE_URL=http://your-host:8123
CLICKHOUSE_USER=default
CLICKHOUSE_PASSWORD=your_password
CLICKHOUSE_DATABASE=clickinsight

# Redisï¼ˆæ—¢å­˜ï¼‰
REDIS_HOST=your-redis-host
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password
```

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®ç¢ºèªäº‹é …

### 1. ClickHouseãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ

```bash
# ClickHouseã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶š
clickhouse-client --host=your-host --user=default --password=your-password

# docs/clickhouse-heatmap-summary-table.sql ã®å†…å®¹ã‚’å®Ÿè¡Œ
```

### 2. Inngestã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®è¨­å®š

1. Inngestãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒ­ã‚°ã‚¤ãƒ³
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆï¼ˆã¾ãŸã¯æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠï¼‰
3. Event Key ã¨ Signing Key ã‚’å–å¾—
4. ç’°å¢ƒå¤‰æ•°ã«è¨­å®š

### 3. åˆæœŸãƒ‡ãƒ¼ã‚¿ã®é›†ç´„

```bash
# ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€1å›ã ã‘å®Ÿè¡Œ
curl -X POST https://your-domain.com/api/inngest/rebuild
```

---

## ğŸ“Š æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„

| æŒ‡æ¨™ | æ”¹å–„å‰ | æ”¹å–„å¾Œ |
|------|--------|--------|
| APIå¿œç­”æ™‚é–“ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ã‚Šï¼‰ | - | < 100ms |
| APIå¿œç­”æ™‚é–“ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ï¼‰ | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | < 3ç§’ |
| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æç”»æ™‚é–“ | 10ç§’ä»¥ä¸Š | < 2ç§’ |
| ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿç‡ | é«˜ | 0% |
| ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆæ•° | æœ€å¤§10,000 | æœ€å¤§500ï¼ˆä¸Šä½ã®ã¿ï¼‰ |

### ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

- âœ… ç”Ÿã‚¤ãƒ™ãƒ³ãƒˆæ•°ãŒ10å€ã«ãªã£ã¦ã‚‚å‡¦ç†æ™‚é–“ã¯å¤‰ã‚ã‚‰ãªã„
- âœ… å¤§è¦æ¨¡ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆ100ä¸‡PV/æ—¥ï¼‰ã§ã‚‚å®‰å®š
- âœ… é›†ç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚ˆã‚Šã€ã‚¯ã‚¨ãƒªãŒé«˜é€ŸåŒ–

---

## ğŸ”„ å‹•ä½œãƒ•ãƒ­ãƒ¼

### 1. æ—¥æ¬¡é›†ç´„ï¼ˆè‡ªå‹•ï¼‰

```
æ¯æœ5:00ï¼ˆJSTï¼‰
  â†“
Inngest: aggregateDaily
  â†“
ClickHouse: events â†’ heatmap_daily_summary
  â†“
é›†ç´„ãƒ‡ãƒ¼ã‚¿ãŒè“„ç©ã•ã‚Œã‚‹
```

### 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¦ã‚©ãƒ¼ãƒŸãƒ³ã‚°ï¼ˆè‡ªå‹•ï¼‰

```
6æ™‚é–“ã”ã¨
  â†“
Inngest: warmCache
  â†“
äººæ°—ãƒšãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  â†“
Redisã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜
```

### 3. ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—é–²è¦§ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚’é–‹ã
  â†“
API: /api/heatmap
  â†“
Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç¢ºèª
  â†“
ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ã‚Š â†’ å³åº§ã«è¿”å´ï¼ˆ< 100msï¼‰
ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã— â†’ é›†ç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å–å¾—ï¼ˆ< 3ç§’ï¼‰
  â†“
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§æ®µéšçš„ã«æç”»ï¼ˆ50ä»¶ãšã¤ï¼‰
```

---

## ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### å³åº§ã«å®Ÿæ–½

1. **Inngestãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
   ```bash
   npm install inngest
   ```

2. **ç’°å¢ƒå¤‰æ•°ã®è¨­å®š**
   - Inngest Event Key ã¨ Signing Key ã‚’å–å¾—
   - `.env.local`ã«è¿½åŠ 

3. **ClickHouseãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ**
   - `docs/clickhouse-heatmap-summary-table.sql`ã‚’å®Ÿè¡Œ

4. **Vercelã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤**
   ```bash
   git add .
   git commit -m "feat: Inngestçµ±åˆã«ã‚ˆã‚‹ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„"
   git push origin main
   ```

5. **åˆæœŸãƒ‡ãƒ¼ã‚¿ã®é›†ç´„**
   ```bash
   curl -X POST https://your-domain.com/api/inngest/rebuild
   ```

### å‹•ä½œç¢ºèª

1. Inngestãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§é–¢æ•°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
2. æ—¥æ¬¡é›†ç´„ã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¦ã‚©ãƒ¼ãƒŸãƒ³ã‚°ãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
4. APIå¿œç­”æ™‚é–“ã‚’æ¸¬å®š

---

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Inngestã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †](./inngest-setup-instructions.md)
- [ClickHouseãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆSQL](./clickhouse-heatmap-summary-table.sql)
- [ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—Inngestå®Ÿè£…ã‚¬ã‚¤ãƒ‰](./heatmap-inngest-implementation-guide.md)

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´1æœˆ26æ—¥


