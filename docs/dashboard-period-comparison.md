# ダッシュボード期間比較機能

**作成日**: 2025年1月26日  
**目的**: 改善施策の効果を測定するため、前期間との比較機能を追加

---

## ✅ 実施した改善

### 1. 期間比較機能の追加

**問題点**:
- 現在の数値だけでは、改善施策の効果を判断できない
- 前期間との比較ができないため、改善が成功したかどうか分からない

**改善内容**:
- ✅ 前期間の統計データを自動取得（選択期間と同じ日数分、前の期間）
- ✅ 各KPIカードに前期間との比較を表示
- ✅ 増減率を計算して表示（`+X.X%` または `-X.X%`）
- ✅ トレンドアイコンを表示（上昇=緑、下降=赤）
- ✅ 直帰率は低い方が良いため、増減の色分けを逆転（増加=赤、減少=緑）

**技術的な変更**:
- `app/dashboard/page.tsx`:
  - `previousStatistics` stateを追加
  - 前期間の計算ロジックを実装
  - `calculateChange`関数を追加して増減率を計算
  - 各KPIカードに比較表示を追加

---

## 📊 比較ロジック

### 前期間の計算

選択期間と同じ日数分の前期間を自動計算：

```typescript
// 例: 過去7日間を選択した場合
// 現在期間: 今日から7日前まで
// 前期間: 8日前から14日前まで（同じ7日間）

const prevEnd = new Date(start)
prevEnd.setDate(prevEnd.getDate() - 1) // 現在期間の1日前まで
const prevStart = new Date(prevEnd)
prevStart.setDate(prevStart.getDate() - days + 1) // 同じ日数分前
```

### 増減率の計算

```typescript
const calculateChange = (current: number, previous: number) => {
  if (!previous || previous === 0) {
    return { value: 'N/A', isPositive: false }
  }
  const change = ((current - previous) / previous) * 100
  const isPositive = change >= 0
  return {
    value: `${isPositive ? '+' : ''}${change.toFixed(1)}%`,
    isPositive
  }
}
```

---

## 🎨 UI表示

### KPIカードの比較表示

各KPIカードに以下の情報を表示：

1. **現在の値**: 大きな数字で表示
2. **増減率**: 前期間との比較（`+X.X%` または `-X.X%`）
3. **トレンドアイコン**: 
   - 上昇: `TrendingUp`（緑色）
   - 下降: `TrendingDown`（赤色）
4. **ラベル**: 「vs 前期間」

### 表示例

```
┌─────────────────────────┐
│ ページビュー数            │
│ 1,234                    │
│ ↗ +15.3% vs 前期間       │
└─────────────────────────┘
```

### 直帰率の特別な表示

直帰率は低い方が良いため、色分けを逆転：

- **増加**（悪化）: 赤色 + `TrendingUp`
- **減少**（改善）: 緑色 + `TrendingDown`

---

## 📈 比較される指標

以下の8つの指標について前期間との比較を表示：

1. **ページビュー数**: アクセス数の変化
2. **セッション数**: ユニークセッション数の変化
3. **総クリック数**: クリックイベント数の変化
4. **クリック率**: セッションあたりの平均クリック数の変化
5. **平均滞在時間**: セッションあたりの平均滞在時間の変化
6. **直帰率**: 1ページビューのセッション割合の変化（色分け逆転）
7. **平均スクロール深度**: ページビューあたりの平均スクロール位置の変化
8. **総イベント数**: 全イベント数の変化

---

## 🔍 動作条件

### 比較が表示される条件

- ✅ 期間選択が「全期間」以外の場合のみ表示
- ✅ 前期間のデータが存在する場合のみ表示
- ✅ 前期間の値が0でない場合のみ表示

### 比較が表示されない場合

- 「全期間」を選択している場合
- 前期間のデータが存在しない場合
- 前期間の値が0の場合（「N/A」と表示）

---

## 💡 使用例

### 改善施策の効果測定

1. **改善前**: 過去30日間のデータを確認
2. **改善実施**: サイトの改善を実施
3. **改善後**: 過去30日間のデータを確認
4. **比較**: 各指標の増減率を確認して効果を測定

### 例: ページビュー数の改善

- **改善前（前期間）**: 1,000 PV
- **改善後（現在期間）**: 1,200 PV
- **増減率**: `+20.0%`（緑色、上昇アイコン）

→ 改善施策が成功したと判断できる

---

## 📝 関連ファイル

- `app/dashboard/page.tsx`: ダッシュボードページのメインコンポーネント

---

## 🎯 今後の改善提案

1. **カスタム期間の選択**: 開始日と終了日を自由に選択できる機能
2. **比較グラフ**: 期間比較をグラフで可視化
3. **複数期間の比較**: 前期間だけでなく、前々期間との比較も可能にする
4. **統計的有意性**: 増減が統計的に有意かどうかを表示

---

**最終更新**: 2025年1月26日

