# 修正内容 - 2025年1月26日

**修正日**: 2025年1月26日  
**目的**: クリック分析ページとダッシュボードの表示問題を修正、期間比較機能とヒートマップページの改善を追加

---

## 🐛 修正した問題

### 問題①: クリック分析ページ（/clicks）にデータが表示されない

**問題の詳細**:
- `/api/clicks`エンドポイントでデータベースのフィールド名が間違っていた
- `created_at`フィールドが存在しない（正しくは`timestamp`）
- `page_url`フィールドが存在しない（正しくは`url`）
- `element_path`フィールドが存在しない
- CTRが計算されていない

**修正内容**:
- ✅ `created_at` → `timestamp`に修正
- ✅ `page_url` → `url`に修正
- ✅ `element_path`を削除し、`element_tag_name`, `element_id`, `element_class_name`を組み合わせて使用
- ✅ CTRの計算を追加（クリック数 / セッション数 * 100）
- ✅ ユニーク要素数の計算を修正（`concat`関数を使用）

**影響範囲**:
- `app/api/clicks/route.ts`: すべてのクエリを修正

---

### 問題②: ダッシュボードの平均滞在時間と直帰率が表示されない

**問題の詳細**:
- `sessions`テーブルからデータを取得しようとしていたが、テーブルにデータが入っていない可能性がある
- セッション統計が正しく計算されていない

**修正内容**:
- ✅ `sessions`テーブルに依存せず、`events`テーブルから直接計算するように変更
- ✅ セッションごとの開始時刻（`min(timestamp)`）と終了時刻（`max(timestamp)`）から滞在時間を計算
- ✅ 1ページビューのセッションを直帰と判定（`page_views <= 1`）
- ✅ 平均滞在時間を秒から分に変換して表示
- ✅ エラーハンドリングを改善

**影響範囲**:
- `lib/clickhouse.ts`: `getStatistics`関数を修正

---

### 問題③: ヒートマップページにサイト選択と期間選択が不足

**問題の詳細**:
- ヒートマップページでサイト選択と期間選択が別々のカードに分かれていた
- 期間選択機能が実装されていなかった
- フィルター機能が使いにくかった

**修正内容**:
- ✅ サイト選択、期間選択、ページ選択を1つのフィルターカードに統合
- ✅ 期間選択機能を追加（過去7日間、30日間、90日間、全期間）
- ✅ 期間選択に基づいてヒートマップデータをフィルタリング
- ✅ UIを改善し、3列のグリッドレイアウトで表示

**影響範囲**:
- `app/heatmap/page.tsx`: フィルターUIの統合と期間選択機能の追加

---

### 問題④: ダッシュボードに期間比較機能がない

**問題の詳細**:
- 改善施策の効果を測定するために、前期間との比較が必要だった
- 現在の数値だけでは、改善が成功したかどうか判断できない

**修正内容**:
- ✅ 前期間の統計データを自動取得（選択期間と同じ日数分、前の期間）
- ✅ 各KPIカードに前期間との比較を表示（増減率とトレンドアイコン）
- ✅ 増減率の計算ロジックを実装（`calculateChange`関数）
- ✅ 直帰率は低い方が良いため、増減の色分けを逆転（増加=赤、減少=緑）
- ✅ 全期間選択時は比較を表示しない

**影響範囲**:
- `app/dashboard/page.tsx`: 期間比較機能の追加

---

## 📝 技術的な変更詳細

### 1. `/api/clicks`エンドポイントの修正

#### 修正前
```typescript
// 間違ったフィールド名
elementQuery += ` AND created_at >= {start_date:String}`
elementQuery += ` AND page_url = {page_url:String}`
element_path as selector
```

#### 修正後
```typescript
// 正しいフィールド名
elementQuery += ` AND timestamp >= {start_date:String}`
elementQuery += ` AND url = {page_url:String}`
// element_pathを削除し、element_tag_name, element_id, element_class_nameを組み合わせ
```

#### CTR計算の追加
```typescript
const sessions = Number(item.unique_sessions) || 0
const clicks = Number(item.clicks) || 0
const ctr = sessions > 0 ? ((clicks / sessions) * 100).toFixed(1) : '0'
```

---

### 2. `getStatistics`関数の修正

#### 修正前
```typescript
// sessionsテーブルから取得（データが入っていない可能性）
let sessionQuery = `
  SELECT 
    avg(duration) as avg_time_on_page,
    countIf(page_views = 1) as bounce_sessions,
    count() as total_sessions
  FROM clickinsight.sessions
  WHERE site_id = {site_id:String}
`
```

#### 修正後
```typescript
// eventsテーブルから直接計算
let sessionQuery = `
  SELECT 
    session_id,
    min(timestamp) as session_start,
    max(timestamp) as session_end,
    countIf(event_type = 'page_view' OR event_type = 'pageview') as page_views,
    count() as total_events
  FROM clickinsight.events
  WHERE site_id = {site_id:String}
  GROUP BY session_id
`

// セッションごとに滞在時間と直帰を計算
for (const session of sessionData) {
  const start = new Date(session.session_start)
  const end = new Date(session.session_end)
  const duration = (end.getTime() - start.getTime()) / 1000 // 秒
  totalDuration += duration
  
  // 1ページビューのセッションを直帰と判定
  if (Number(session.page_views) <= 1) {
    bounceSessions++
  }
}
```

### 3. ヒートマップページのフィルター統合

#### 修正前
```tsx
{/* サイト選択 */}
<Card>
  <CardHeader>
    <CardTitle>サイトとページを選択</CardTitle>
  </CardHeader>
  <CardContent>
    {/* サイト選択 */}
    {/* ページ選択 */}
  </CardContent>
</Card>
```

#### 修正後
```tsx
{/* サイト選択と期間選択 */}
<Card>
  <CardHeader>
    <CardTitle>フィルター</CardTitle>
    <CardDescription>サイト、期間、ページを選択してヒートマップを表示</CardDescription>
  </CardHeader>
  <CardContent>
    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
      {/* サイト選択 */}
      {/* 期間選択 */}
      {/* ページ選択 */}
    </div>
  </CardContent>
</Card>
```

#### 期間選択の実装
```typescript
const [dateRange, setDateRange] = useState<'all' | '7days' | '30days' | '90days'>('all')

// 期間に基づいてAPIリクエストを送信
if (dateRange !== 'all') {
  const end = new Date()
  const start = new Date()
  switch (dateRange) {
    case '7days': start.setDate(start.getDate() - 7); break
    case '30days': start.setDate(start.getDate() - 30); break
    case '90days': start.setDate(start.getDate() - 90); break
  }
  startDate = start.toISOString().split('T')[0]
  endDate = end.toISOString().split('T')[0]
}
```

---

### 4. ダッシュボードの期間比較機能

#### 前期間の計算
```typescript
// 前期間の計算（同じ日数分、前の期間）
const prevEnd = new Date(start)
prevEnd.setDate(prevEnd.getDate() - 1) // 現在期間の1日前まで
const prevStart = new Date(prevEnd)
prevStart.setDate(prevStart.getDate() - days + 1) // 同じ日数分前
```

#### 増減率の計算
```typescript
const calculateChange = (current: number, previous: number): { value: string; isPositive: boolean } => {
  if (!previous || previous === 0) {
    return { value: 'N/A', isPositive: false }
  }
  const change = ((current - previous) / previous) * 100
  const isPositive = change >= 0
  return {
    value: `${isPositive ? '+' : ''}${change.toFixed(1)}%`,
    isPositive
  }
}
```

#### KPIカードへの表示
```tsx
{kpiData.pageViewsChange && (
  <div className={`flex items-center gap-1 ${kpiData.pageViewsChange.isPositive ? 'text-green-600' : 'text-red-600'}`}>
    {kpiData.pageViewsChange.isPositive ? (
      <TrendingUp className="w-4 h-4" />
    ) : (
      <TrendingDown className="w-4 h-4" />
    )}
    <span className="font-medium">{kpiData.pageViewsChange.value}</span>
    <span className="text-gray-500">vs 前期間</span>
  </div>
)}
```

---

## ✅ 修正後の動作確認項目

1. **クリック分析ページ**:
   - ✅ サイトを選択すると、クリックデータが表示される
   - ✅ 要素別、ページ別、デバイス別の統計が正しく表示される
   - ✅ CTRが正しく計算されて表示される
   - ✅ 期間フィルターが正しく動作する

2. **ダッシュボード**:
   - ✅ 平均滞在時間が正しく表示される（分単位）
   - ✅ 直帰率が正しく表示される（%）
   - ✅ セッション数が正しく表示される
   - ✅ 期間フィルターが正しく動作する
   - ✅ 前期間との比較が正しく表示される（期間選択時のみ）
   - ✅ 増減率が正しく計算され、トレンドアイコンが表示される
   - ✅ 直帰率の増減表示が正しく色分けされる（増加=赤、減少=緑）

3. **ヒートマップページ**:
   - ✅ サイト選択、期間選択、ページ選択が1つのフィルターカードに統合されている
   - ✅ 期間選択に基づいてヒートマップデータがフィルタリングされる
   - ✅ 期間選択が正しく動作する（過去7日間、30日間、90日間、全期間）

---

## 📊 関連ファイル

- `app/api/clicks/route.ts`: クリック分析APIエンドポイント
- `lib/clickhouse.ts`: 統計データ取得関数
- `app/dashboard/page.tsx`: ダッシュボードページ（Siteインターフェースの修正、期間比較機能の追加）
- `app/heatmap/page.tsx`: ヒートマップページ（フィルター統合、期間選択機能の追加）

---

## 🔍 追加の修正

### Siteインターフェースの修正

**問題**: APIは`url`を返すが、フロントエンドは`domain`を期待していた

**修正**:
- ✅ `Site`インターフェースに`url`フィールドを追加
- ✅ `domain`フィールドをオプショナルに変更（後方互換性のため）
- ✅ 表示時に`site.url || site.domain || 'N/A'`を使用

**影響範囲**:
- `app/dashboard/page.tsx`: Siteインターフェースと表示ロジックを修正

---

## 🎯 今後の改善提案

1. **パフォーマンス最適化**: セッション統計の計算をキャッシュする
2. **エラーハンドリング**: より詳細なエラーメッセージを表示
3. **データ検証**: データの整合性チェックを追加
4. **テスト**: ユニットテストとE2Eテストを追加
5. **期間比較の拡張**: カスタム期間の選択機能を追加
6. **比較グラフ**: 期間比較をグラフで可視化

---

## 📈 追加機能の詳細

### 期間比較機能の仕様

**比較対象**:
- 選択期間と同じ日数分の前期間と比較
- 例: 過去7日間を選択 → その前の7日間と比較
- 例: 過去30日間を選択 → その前の30日間と比較

**表示される指標**:
- ページビュー数
- セッション数
- 総クリック数
- クリック率
- 平均滞在時間
- 直帰率（増加=悪化、減少=改善として色分け）
- 平均スクロール深度
- 総イベント数

**表示形式**:
- 増減率: `+X.X%` または `-X.X%`
- トレンドアイコン: 上昇（緑）または下降（赤）
- 「vs 前期間」のラベル

---

---

## 📚 関連ドキュメント

- [ヒートマップタイプの実装状況](./heatmap-types-status.md) - 3種類のヒートマップタイプの実装状況
- [パフォーマンス改善提案](./performance-optimization-proposal.md) - データ量増加に伴うパフォーマンス改善策
- [ヒートマップフィルター改善](./heatmap-filter-improvements.md) - ヒートマップページのフィルター統合
- [ダッシュボード期間比較機能](./dashboard-period-comparison.md) - 期間比較機能の詳細

---

**最終更新**: 2025年1月26日

