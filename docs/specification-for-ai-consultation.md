# ClickInsight Pro - 包括的仕様書（AI相談用）

**作成日**: 2025年1月25日  
**目的**: AIに相談するための現在の実装状況と改善点の整理

---

## 📋 プロジェクト概要

### 基本情報
- **プロジェクト名**: ClickInsight Pro (heatclick-ai)
- **説明**: AI搭載のヒートマップ・クリック分析ツール - WordPressサイトを中心としたWebサイトのクリック行動とヒートマップを可視化・分析し、AIによる自動診断と改善提案を行う次世代SEO特化型ツール
- **開発フェーズ**: MVP開発完了 / データベース統合待ち
- **本番URL**: https://heatclick-p47dqkc2q-hiroki101313-gmailcoms-projects.vercel.app
- **デプロイプラットフォーム**: Vercel

### ビジネスモデル
- **料金プラン**:
  - Free: ¥0/月、5,000 PV/月、1サイト
  - Starter: ¥4,980/月、50,000 PV/月、3サイト
  - Professional: ¥9,800/月、500,000 PV/月、10サイト
  - Business: ¥24,800/月、2,000,000 PV/月、50サイト

---

## 🏗️ 技術スタック

### フロントエンド
- **フレームワーク**: Next.js 14 (App Router)
- **言語**: TypeScript
- **UIライブラリ**: React 18
- **スタイリング**: Tailwind CSS + shadcn/ui
- **状態管理**: React Hooks（Zustandは導入済みだが未使用）
- **チャート**: Recharts
- **ヒートマップ**: heatmap.js
- **アイコン**: Lucide React

### バックエンド
- **API**: Next.js API Routes
- **データベース**: ClickHouse（実装済みだが未接続、モック実装）
- **キャッシュ**: Redis（実装済みだが未接続、モック実装）
- **外部API**: 
  - Claude API（未連携、モックデータ使用）
  - Google Search Console API（未連携）
  - Google Ads API（未連携）
  - Google Analytics 4（未連携）

### インフラ
- **フロントエンドホスティング**: Vercel
- **データベースサーバー**: Hetzner Cloud（セットアップスクリプト準備済み）
- **データベース**: ClickHouse（Hetzner）
- **キャッシュ**: Redis（Hetzner）
- **CDN**: Vercel Edge Network

---

## 📱 実装済み機能

### 1. ダッシュボード (`/dashboard`)
**実装状況**: ✅ 完了（サンプルデータ表示）

**機能**:
- KPIカード表示（総クリック数、クリック率、平均滞在時間、直帰率）
- トップクリック要素ランキング
- 検索クエリ別パフォーマンス
- チャート表示（Recharts）

**課題**:
- データがサンプルデータのみ
- ClickHouseから実際のデータを取得する必要がある

### 2. リアルタイムページ (`/realtime`)
**実装状況**: ✅ 完了（メモリ内データ）

**機能**:
- ライブデータ監視（5秒間隔で自動更新）
- 統計情報表示（総イベント数、ユニークユーザー、セッション数、クリック数）
- イベント履歴表示
- トラッキングスクリプト情報

**課題**:
- データがメモリ内のみ（サーバー再起動で消失）
- Redis Pub/Subを使用したリアルタイム更新が未実装

### 3. ヒートマップページ (`/heatmap`)
**実装状況**: ✅ 完了（モックデータ）

**機能**:
- ページ統計ダッシュボード
- 視覚的ヒートマップ表示（heatmap.js）
- 詳細クリックデータ
- AI改善提案機能（UIのみ、実際のAI分析は未実装）
- 流入元・クエリ別分析

**課題**:
- 実際のヒートマップデータが表示されない
- AI分析機能が未実装

### 4. サイト管理ページ (`/sites`)
**実装状況**: ✅ 完了（ClickHouse統合済みコード）

**機能**:
- サイト登録・管理
- トラッキングID自動生成（形式: `CIP_` + 16文字）
- トラッキングコード生成・コピー機能
- サイト登録後のトラッキングID自動表示モーダル
- サイト一覧表示
- サイト削除機能
- GTM連携説明

**課題**:
- ClickHouseが未接続のため、データがメモリ内に保存される
- サーバー再起動でデータ消失

### 5. クリック分析ページ (`/clicks`)
**実装状況**: ✅ 完了（モックデータ）

**機能**:
- 詳細クリックデータ分析
- フィルター機能（サイト、期間、ページ）
- ページ別・デバイス別分析
- エクスポート機能（UIのみ）

**課題**:
- 実際のデータが表示されない
- エクスポート機能が未実装

### 6. AI分析ページ (`/ai-insights`)
**実装状況**: ⚠️ UIのみ実装、機能は未実装

**機能**:
- Claude Sonnet 4による自動分析（未実装）
- 優先度別改善提案（緊急・重要・SEO）（UIのみ）
- 実装コード自動生成（未実装）
- 分析履歴管理（UIのみ）

**課題**:
- Claude API連携が未実装
- 実際のAI分析機能が動作しない

### 7. レポートページ (`/reports`)
**実装状況**: ⚠️ UIのみ実装

**機能**:
- 複数レポートテンプレート（UIのみ）
- 自動レポート生成（未実装）
- 生成済みレポート管理（UIのみ）
- 自動配信設定（未実装）

**課題**:
- レポート生成機能が未実装
- 自動配信機能が未実装

### 8. 設定ページ (`/settings`)
**実装状況**: ✅ 完了（UIのみ）

**機能**:
- トラッキングスクリプト管理（UIのみ）
- アカウント設定（UIのみ）
- 通知設定（UIのみ）
- データ管理（UIのみ）

**課題**:
- 実際の設定保存機能が未実装
- 認証システムがないため、ユーザー設定が保存できない

### 9. インストールページ (`/install`)
**実装状況**: ✅ 完了

**機能**:
- プラットフォーム別インストールコード生成（WordPress, HTML, React, Next.js）
- トラッキングID表示
- コピー機能

---

## 🔧 トラッキングシステム

### トラッキングスクリプト
**ファイル**: `public/track.js`, `public/tracking.js`

**実装状況**: ✅ 基本実装完了

**機能**:
- クリック、スクロール、マウス移動、ページビューの追跡
- セッション管理とユーザー識別
- 非同期データ送信
- エラーハンドリング

**課題**:
- 本番環境URLがハードコードされていない（`localhost`が含まれている）
- スクリプトサイズが5KB以下に最適化されていない
- バッチ送信が未実装

### APIエンドポイント

#### `/api/track` (POST, GET)
**実装状況**: ✅ 完了（ClickHouse統合コード実装済み）

**機能**:
- トラッキングデータ受信
- バッチイベント対応
- ClickHouseへの保存（コード実装済み、接続待ち）
- Redis Pub/Subによるリアルタイム通知（コード実装済み、接続待ち）

**課題**:
- ClickHouseが未接続のため、メモリ内にフォールバック

#### `/api/events` (POST, GET)
**実装状況**: ✅ 完了（モック実装）

**機能**:
- イベントデータ受信
- データバリデーション

**課題**:
- ClickHouseへの保存が未実装

#### `/api/sites` (GET, POST)
**実装状況**: ✅ 完了（ClickHouse統合コード実装済み）

**機能**:
- サイト一覧取得
- サイト登録
- トラッキングID自動生成

**課題**:
- ClickHouseが未接続のため、メモリ内にフォールバック

#### `/api/sites/[id]` (GET, PUT, DELETE)
**実装状況**: ✅ 完了（ClickHouse統合コード実装済み）

**機能**:
- サイト情報取得
- サイト情報更新
- サイト削除

**課題**:
- ClickHouseが未接続のため、メモリ内にフォールバック

#### `/api/install` (GET)
**実装状況**: ✅ 完了

**機能**:
- プラットフォーム別インストールコード生成

#### `/api/heatmap` (GET)
**実装状況**: ⚠️ モック実装

**課題**:
- ClickHouseから実際のデータを取得する必要がある

#### `/api/statistics` (GET, POST)
**実装状況**: ⚠️ モック実装

**課題**:
- ClickHouseから実際のデータを取得する必要がある

---

## 🗄️ データベース設計

### ClickHouse

#### データベース: `clickinsight`

#### テーブル1: `sites`
**実装状況**: ✅ スキーマ設計完了、セットアップスクリプトに含まれる

**スキーマ**:
```sql
CREATE TABLE IF NOT EXISTS clickinsight.sites (
    id String,
    name String,
    url String,
    tracking_id String,
    status String,
    created_at DateTime,
    updated_at DateTime,
    last_activity DateTime,
    page_views UInt64
) ENGINE = MergeTree()
ORDER BY (id)
```

**課題**:
- テーブルはセットアップスクリプトで作成されるが、実際の接続が未実装

#### テーブル2: `events`
**実装状況**: ✅ スキーマ設計完了、セットアップスクリプトに含まれる

**スキーマ**:
```sql
CREATE TABLE IF NOT EXISTS clickinsight.events (
    id String,
    site_id String,
    session_id String,
    user_id Nullable(String),
    event_type String,
    timestamp DateTime,
    url String,
    referrer Nullable(String),
    user_agent String,
    viewport_width UInt16,
    viewport_height UInt16,
    element_tag_name Nullable(String),
    element_id Nullable(String),
    element_class_name Nullable(String),
    element_text Nullable(String),
    element_href Nullable(String),
    click_x UInt16,
    click_y UInt16,
    scroll_y UInt16,
    scroll_percentage UInt8,
    received_at DateTime DEFAULT now()
) ENGINE = MergeTree()
ORDER BY (site_id, timestamp)
PARTITION BY toYYYYMM(timestamp)
```

**課題**:
- テーブルはセットアップスクリプトで作成されるが、実際の接続が未実装

#### テーブル3: `users`（未実装）
**実装状況**: ❌ 未実装

**必要な理由**:
- 認証システムに必要
- ユーザー管理機能に必要

### Redis

**実装状況**: ✅ クライアント実装完了（モック実装）

**用途**:
- ヒートマップデータのキャッシュ（TTL: 1時間）
- 統計データのキャッシュ（TTL: 30分）
- セッションデータのキャッシュ（TTL: 24時間）
- リアルタイムデータのPub/Sub

**課題**:
- 実際の接続が未実装
- モック実装のまま動作している

---

## 🔐 認証システム

**実装状況**: ❌ 未実装

**必要な機能**:
- ユーザー登録
- ログイン/ログアウト
- セッション管理
- パスワードリセット
- メール認証

**推奨実装**:
- NextAuth.js v5（Auth.js）を使用
- データベース: ClickHouseに`users`テーブルを追加、またはPostgreSQLを追加検討

**影響**:
- 現在、すべてのページが認証なしでアクセス可能
- ユーザーごとのデータ分離ができない
- マルチテナント機能が実現できない

---

## 🚨 改善すべき点（優先度別）

### 🔴 優先度: 緊急（即座に対応が必要）

#### 1. データベース接続の実装
**現状**:
- ClickHouseとRedisのクライアントコードは実装済み
- しかし、実際の接続が未実装（モック実装のまま）
- データがメモリ内に保存され、サーバー再起動で消失

**必要な作業**:
1. HetznerサーバーでClickHouseとRedisをセットアップ（`scripts/setup-server.sh`を使用）
2. Vercelに環境変数を設定
3. 接続テストと動作確認

**影響**:
- データが永続化されない
- 本番環境で使用できない

#### 2. 認証システムの実装
**現状**:
- 認証システムが一切実装されていない
- すべてのページが認証なしでアクセス可能

**必要な作業**:
1. NextAuth.js v5のセットアップ
2. ユーザーテーブルの作成（ClickHouseまたはPostgreSQL）
3. ログイン/登録ページの実装
4. 認証ミドルウェアの実装

**影響**:
- マルチテナント機能が実現できない
- セキュリティリスク
- ユーザーごとのデータ分離ができない

### 🟡 優先度: 高（1-2週間以内）

#### 3. トラッキングスクリプトの改善
**現状**:
- 本番環境URLがハードコードされていない
- スクリプトサイズが最適化されていない
- バッチ送信が未実装

**必要な作業**:
1. 環境変数から動的にURLを取得するように修正
2. スクリプトの最適化（5KB以下目標）
3. バッチ送信の実装

**影響**:
- 本番環境で正しく動作しない可能性
- パフォーマンスの問題

#### 4. 外部API連携
**現状**:
- Claude API: 未連携（AI分析機能が動作しない）
- Google Search Console API: 未連携
- Google Ads API: 未連携
- Google Analytics 4: 未連携

**必要な作業**:
1. Claude API連携（AI分析機能）
2. Google Search Console API連携
3. Google Ads API連携（オプション）
4. Google Analytics 4連携（オプション）

**影響**:
- AI分析機能が使用できない
- SEO分析機能が不完全

#### 5. データ取得APIの実装
**現状**:
- `/api/heatmap`: モック実装
- `/api/statistics`: モック実装
- 実際のデータが表示されない

**必要な作業**:
1. ClickHouseからヒートマップデータを取得する実装
2. ClickHouseから統計データを取得する実装
3. キャッシュ機能の実装（Redis）

**影響**:
- ダッシュボード、ヒートマップ、統計ページが正しく動作しない

### 🟢 優先度: 中（1ヶ月以内）

#### 6. UI/UX改善
**現状**:
- ローディング状態が不十分
- エラーメッセージが不親切
- レスポンシブデザインが最適化されていない

**必要な作業**:
1. ローディングスピナーの追加
2. エラーハンドリングの改善
3. レスポンシブデザインの最適化

#### 7. セキュリティ強化
**現状**:
- CORS設定は一部実装済み
- API Rate Limitingが未実装
- 認証・認可システムが未実装

**必要な作業**:
1. API Rate Limitingの実装
2. 認証・認可システムの実装
3. データプライバシー対応（GDPR等）

#### 8. パフォーマンス最適化
**現状**:
- トラッキングスクリプトのサイズが最適化されていない
- 大量イベントデータの処理が未実装
- バッチインサートが未実装

**必要な作業**:
1. トラッキングスクリプトの最適化
2. バッチ処理の実装
3. キャッシュ戦略の最適化

### 🔵 優先度: 低（将来の拡張）

#### 9. 追加機能の実装
- A/Bテスト機能
- セッションリプレイ機能
- ファネル分析
- コンバージョン率最適化（CRO）ツール

#### 10. ドキュメント整備
- API仕様書の作成
- セットアップガイドの作成
- ユーザーマニュアルの作成

---

## ⚠️ 技術的課題

### 1. データベース接続
**問題**:
- ClickHouseとRedisのクライアントコードは実装済みだが、実際の接続が未実装
- モック実装のまま動作している

**解決策**:
- HetznerサーバーでClickHouseとRedisをセットアップ
- 環境変数をVercelに設定
- 接続テストを実施

### 2. 認証システム
**問題**:
- 認証システムが一切実装されていない
- マルチテナント機能が実現できない

**解決策**:
- NextAuth.js v5を導入
- ユーザーテーブルを作成
- 認証ミドルウェアを実装

### 3. 外部API連携
**問題**:
- Claude API、Google APIsが未連携
- AI分析機能が動作しない

**解決策**:
- 各APIの認証情報を取得
- API連携コードを実装
- エラーハンドリングを実装

### 4. トラッキングスクリプト
**問題**:
- 本番環境URLがハードコードされていない
- スクリプトサイズが最適化されていない

**解決策**:
- 環境変数から動的にURLを取得
- スクリプトの最適化
- バッチ送信の実装

### 5. パフォーマンス
**問題**:
- 大量イベントデータの処理が未実装
- バッチインサートが未実装

**解決策**:
- バッチ処理の実装
- キャッシュ戦略の最適化
- インデックスの最適化

---

## 💼 ビジネス課題

### 1. 外部APIコスト管理
**問題**:
- Claude APIのコストが不明
- Google APIsのクォータ管理が必要

**解決策**:
- API使用量の監視
- コスト上限の設定
- クォータ管理の実装

### 2. 収益モデル
**問題**:
- 料金プランは定義済みだが、決済システムが未実装

**解決策**:
- StripeまたはPayPalの導入
- サブスクリプション管理の実装
- 使用量制限の実装

---

## 📊 現在の実装状況サマリー

### ✅ 実装完了
- フロントエンドUI（全ページ）
- トラッキングスクリプト（基本機能）
- サイト管理機能（UI + API）
- データベースクライアント（コード実装済み）
- Vercelデプロイ

### ⚠️ 部分実装
- APIエンドポイント（コード実装済み、データベース接続待ち）
- データベースクライアント（モック実装）
- トラッキングスクリプト（基本機能は実装済み、最適化待ち）

### ❌ 未実装
- 認証システム
- 外部API連携（Claude, GSC, GA4等）
- データ取得API（ClickHouseから実際のデータ取得）
- レポート生成機能
- エクスポート機能
- 決済システム

---

## 🎯 次のステップ（推奨順序）

1. **データベース接続の実装**（最優先）
   - Hetznerサーバーセットアップ
   - 環境変数設定
   - 接続テスト

2. **認証システムの実装**
   - NextAuth.js v5セットアップ
   - ユーザーテーブル作成
   - ログイン/登録ページ実装

3. **データ取得APIの実装**
   - ClickHouseから実際のデータを取得
   - キャッシュ機能の実装

4. **トラッキングスクリプトの改善**
   - 本番環境URL対応
   - 最適化

5. **外部API連携**
   - Claude API連携
   - Google APIs連携

---

## 📝 AIに相談すべき具体的な質問

1. **データベース接続の最適化**
   - VercelからHetznerのClickHouse/Redisへの接続を最適化する方法
   - 接続プールの設定方法
   - エラーハンドリングのベストプラクティス

2. **認証システムの設計**
   - ClickHouseを使用した認証システムの設計
   - NextAuth.js v5とClickHouseの統合方法
   - マルチテナント機能の実装方法

3. **パフォーマンス最適化**
   - 大量イベントデータの処理方法
   - バッチインサートの最適化
   - キャッシュ戦略の最適化

4. **トラッキングスクリプトの最適化**
   - 5KB以下への最適化方法
   - バッチ送信の実装方法
   - エラーハンドリングの強化

5. **外部API連携**
   - Claude APIの効率的な使用方法
   - Google APIsのクォータ管理
   - APIコストの最適化

---

**このドキュメントは、AIに相談する際の参考資料として使用してください。**



