# ClickHouseプラン・制限の分析

**作成日**: 2025年1月26日  
**目的**: ClickHouseのプランや制限に関する問題がないか確認

---

## 📊 現在の実装状況

### 使用しているClickHouse

**実装方法**: セルフホスト（Hetzner Cloud）  
**ドキュメント**: `scripts/setup-server.sh`でセットアップ予定

### 現在の設定

```typescript
// lib/clickhouse.ts
{
  request_timeout: 30000,        // 30秒
  max_open_connections: 10,      // 最大10接続
}
```

---

## ✅ ClickHouseのプランについて

### 1. セルフホスト（現在の予定）

**ClickHouseはオープンソースで無料**

- ✅ **料金**: 無料（オープンソース）
- ✅ **制限**: サーバーリソース（CPU、メモリ、ストレージ）次第
- ✅ **接続数**: 制限なし（サーバーリソース次第）
- ✅ **データ量**: 制限なし（ストレージ容量次第）
- ✅ **リクエスト数**: 制限なし（CPU/メモリ次第）

**注意点**:
- サーバー（Hetzner Cloud）の料金は別途必要
- サーバーリソースに応じたパフォーマンス

### 2. ClickHouse Cloud（マネージドサービス）

もしClickHouse Cloudを使用する場合：

**無料プラン（Free Tier）**:
- ⚠️ **データ量**: 1GBまで
- ⚠️ **接続数**: 制限あり（プランによる）
- ⚠️ **リクエスト数**: 制限あり（プランによる）

**有料プラン**:
- データ量、接続数、リクエスト数に応じた料金

**現在の実装では使用していない**: セルフホストを予定しているため、プラン制限はありません。

---

## 🔍 現在の実装での潜在的な問題

### 1. 接続数の設定

**現在の設定**:
```typescript
max_open_connections: 10
```

**問題点**:
- Vercelはサーバーレス環境のため、複数のインスタンスが同時に動作する可能性がある
- 各インスタンスが10接続を開くと、合計で多くの接続が発生する可能性
- ClickHouseサーバーの`max_connections`設定を確認する必要がある

**推奨**:
- ClickHouseサーバーの`max_connections`を適切に設定
- 接続プールの最適化
- 接続の再利用

### 2. タイムアウト設定

**現在の設定**:
```typescript
request_timeout: 30000  // 30秒
```

**問題点**:
- 複雑なクエリや大量データの処理でタイムアウトする可能性
- Vercelの関数タイムアウト（10秒〜60秒）との整合性

**推奨**:
- クエリの最適化
- 必要に応じてタイムアウトを調整
- バッチ処理の実装

### 3. リクエスト数の制限

**現在の実装**:
- リクエスト数の制限チェックなし
- レート制限の実装なし

**問題点**:
- 大量のトラッキングデータが送信された場合、ClickHouseサーバーに負荷がかかる
- DDoS攻撃に対する保護がない

**推奨**:
- APIレート制限の実装（`lib/rate-limit.ts`は実装済みだが、ClickHouseへの適用が必要）
- バッチ処理の実装
- クォータ管理の実装

---

## 📋 確認すべき項目

### セルフホストの場合

1. **サーバーリソース**
   - CPU: 十分か？
   - メモリ: 十分か？
   - ストレージ: 十分か？

2. **ClickHouse設定**
   - `max_connections`: 適切に設定されているか？
   - `max_concurrent_queries`: 適切に設定されているか？
   - `max_server_memory_usage`: 適切に設定されているか？

3. **ネットワーク**
   - 帯域幅: 十分か？
   - レイテンシ: 許容範囲内か？

### ClickHouse Cloudを使用する場合

1. **プラン選択**
   - データ量に応じたプラン
   - 接続数に応じたプラン
   - リクエスト数に応じたプラン

2. **制限の確認**
   - データ量の制限
   - 接続数の制限
   - リクエスト数の制限

---

## ✅ 結論

### プラン関連の問題: **なし**

**理由**:
1. セルフホスト（Hetzner Cloud）を予定しているため、ClickHouse自体は無料
2. オープンソース版に制限はない
3. サーバーリソース次第でスケール可能

### 注意すべき点

1. **接続数の管理**
   - 現在の設定（`max_open_connections: 10`）は適切
   - ClickHouseサーバーの`max_connections`設定を確認

2. **パフォーマンス**
   - サーバーリソースに応じたパフォーマンス
   - 必要に応じてサーバーをスケールアップ

3. **コスト**
   - ClickHouse自体は無料
   - Hetzner Cloudサーバーの料金のみ必要

---

## 🎯 推奨事項

### 即座に実施すべきこと

1. **ClickHouseサーバーの設定確認**
   ```bash
   # ClickHouseサーバーで確認
   clickhouse-client --query="SELECT * FROM system.settings WHERE name LIKE '%connection%'"
   ```

2. **接続数の監視**
   - 接続数の監視を実装
   - 必要に応じてアラートを設定

3. **パフォーマンステスト**
   - 負荷テストの実施
   - ボトルネックの特定

### 将来的に検討すべきこと

1. **接続プールの最適化**
   - 接続の再利用
   - 接続数の動的調整

2. **レート制限の実装**
   - APIレート制限の適用
   - クォータ管理の実装

3. **モニタリング**
   - 接続数の監視
   - パフォーマンスの監視
   - アラートの設定

---

**最終更新**: 2025年1月26日

